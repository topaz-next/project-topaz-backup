**Labels:**

bug



<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="96" height="96" hspace="10"></img></a> **Issue by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:38:23_
_Originally opened as: project-topaz/topaz - Issue 149_

----

<a href="https://github.com/R3P0FFXI"><img src="https://avatars2.githubusercontent.com/u/10148511?v=4"  width="96" height="96" hspace="10"></img></a> **Issue by [R3P0FFXI](https://github.com/R3P0FFXI)**
_Tuesday Dec 27, 2016 at 01:44 GMT_
_Originally opened as DarkstarProject/darkstar - Issue 3601_

----

<!-- remove space and mark with 'x' between [] -->

**_I have:_**

- [x] searched existing issues (http://github.com/darkstarproject/darkstar - Issue ) to see if the issue I am posting has already been addressed or opened by another contributor
- [x] checked the commit log to see if my issue has been resolved since my server was last updated


<!-- Issues will be closed without being looked into if the following information is missing (unless its not applicable). -->

**_Client Version_** (type `/ver` in game) **:**
30161004_

**_Server Version_** (type `revision` in game) **:**
github/DarkstarProject/darkstar/commit/eb97e4f9b8a53c7a0c6532125c6da0b6a96485a3

**_Source Branch_** (master/stable) **:**
Master

**_Additional Information_** (Steps to reproduce/Expected behavior) **:**

https://www.dropbox.com/s/a6wlaldol2owps6/status%20effect%20container.7z?dl=0



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:38:25_

----

<a href="https://github.com/teschnei"><img src="https://avatars3.githubusercontent.com/u/1149183?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [teschnei](https://github.com/teschnei)**
_Tuesday Dec 27, 2016 at 02:59 GMT_

----

Doesn't seem to be anything stock, do you have a custom script for Thinkers
in Promyvion-Holla?

On Mon, Dec 26, 2016 at 6:44 PM, R3P0FFXI <notificationsgithub.com> wrote:

> *I have:*
>
>    - searched existing issues (http://github.com/darkstarproject/darkstar/
>    issues/ <github/darkstarproject/darkstar - Issue >) to see
>    if the issue I am posting has already been addressed or opened by another
>    contributor
>    - checked the commit log to see if my issue has been resolved since my
>    server was last updated
>
> *Client Version* (type /ver in game) *:*
> 30161004_
>
> *Server Version* (type revision in game) *:*
> eb97e4f
> <github/DarkstarProject/darkstar/commit/eb97e4f9b8a53c7a0c6532125c6da0b6a96485a3>
>
> *Source Branch* (master/stable) *:*
> Master
>
> *Additional Information* (Steps to reproduce/Expected behavior) *:*
>
> https://www.dropbox.com/s/a6wlaldol2owps6/status%
> 20effect%20container.7z?dl=0
>
> —
> You are receiving this because you are subscribed to this thread.
> Reply to this email directly, view it on GitHub
> <github/DarkstarProject/darkstar - Issue 3601>, or mute the
> thread
> <github/notifications/unsubscribe-auth/ABGI__EEitorPvTuC1jkyqtkQZeOjhePks5rMG2CgaJpZM4LV-Qg>
> .
>




----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:38:26_

----

<a href="https://github.com/R3P0FFXI"><img src="https://avatars2.githubusercontent.com/u/10148511?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [R3P0FFXI](https://github.com/R3P0FFXI)**
_Tuesday Dec 27, 2016 at 03:03 GMT_

----

teschnei No we do not everything to 75 on our server is DSP stock



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:38:27_

----

<a href="https://github.com/Hozu"><img src="https://avatars3.githubusercontent.com/u/12777366?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [Hozu](https://github.com/Hozu)**
_Tuesday Dec 27, 2016 at 16:56 GMT_

----

Thinkers are the mobs that can steal buffs right? Maybe it has something to do with that.



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:38:28_

----

<a href="https://github.com/teschnei"><img src="https://avatars3.githubusercontent.com/u/1149183?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [teschnei](https://github.com/teschnei)**
_Tuesday Dec 27, 2016 at 17:45 GMT_

----

Yes, it was during Binary Tap that this happened.

On Tue, Dec 27, 2016 at 9:56 AM, Hozu <notificationsgithub.com> wrote:

> Thinkers are the mobs that can steal buffs right? Maybe it has something
> to do with that.
>
> —
> You are receiving this because you were mentioned.
> Reply to this email directly, view it on GitHub
> <github/DarkstarProject/darkstar - Issue 3601Darkstar Issue issuecomment-269352034>,
> or mute the thread
> <github/notifications/unsubscribe-auth/ABGI_wjfvmOVaGfjgk-LzmAmOpj6NPonks5rMUM2gaJpZM4LV-Qg>
> .
>




----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:38:29_

----

<a href="https://github.com/Hozu"><img src="https://avatars3.githubusercontent.com/u/12777366?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [Hozu](https://github.com/Hozu)**
_Tuesday Dec 27, 2016 at 18:11 GMT_

----

I remember looking at how to properly handle stealing buffs for Aura Steal, but I couldn't figure it out. Buff theft/copying needs to be reworked.

Edit: Fixing this may need to go hand in hand with fixing the bug that allows players to cancel any status via sending the packet, since the easiest way to check which buffs are eligible for theft would be simply to check if the player can cancel it (+food for Thinker mobskills). Which... isn't promising because nobody seems to know where to find that information in the client files.



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:38:30_

----

<a href="https://github.com/nfaletra"><img src="https://avatars1.githubusercontent.com/u/11480851?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [nfaletra](https://github.com/nfaletra)**
_Friday Jan 19, 2018 at 21:00 GMT_

----

```
lua_getglobal(L, CLuaStatusEffect::className);
        lua_pushstring(L, "new");
        lua_gettable(L, -2);
        lua_insert(L, -2);
        lua_pushlightuserdata(L, (void*)PStatusEffect);
        lua_pcall(L, 2, 1, 0);

        delete PStatusEffect;
    }
```

Seems like that delete is getting hit before the data actually processes on the lua side. Trying to use this function and use the return value to add the status effect to a different entity crashes or the data is garbage and fails to work anyway.



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:38:32_

----

<a href="https://github.com/teschnei"><img src="https://avatars3.githubusercontent.com/u/1149183?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [teschnei](https://github.com/teschnei)**
_Friday Jan 19, 2018 at 21:09 GMT_

----

That could be it. Fun thing is, if we don't delete it, it's a memory leak.
StealStatusEffect not very well implemented

On Jan 19, 2018 2:00 PM, "Autkast" <notificationsgithub.com> wrote:

> lua_getglobal(L, CLuaStatusEffect::className);
>         lua_pushstring(L, "new");
>         lua_gettable(L, -2);
>         lua_insert(L, -2);
>         lua_pushlightuserdata(L, (void*)PStatusEffect);
>         lua_pcall(L, 2, 1, 0);
>
>         delete PStatusEffect;
>     }
>
> Seems like that delete is getting hit before the data actually processes
> on the lua side. Trying to use this function and use the return value to
> add the status effect to a different entity crashes or the data is garbage
> and fails to work anyway.
>
> —
> You are receiving this because you were mentioned.
> Reply to this email directly, view it on GitHub
> <github/DarkstarProject/darkstar - Issue 3601Darkstar Issue issuecomment-359087706>,
> or mute the thread
> <github/notifications/unsubscribe-auth/ABGI_6xkIhE9fma5OhpynnLshNA3FYetks5tMQKEgaJpZM4LV-Qg>
> .
>




----
<a href="https://github.com/UynGH"><img src="https://avatars2.githubusercontent.com/u/40763842?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [UynGH](https://github.com/UynGH)**
_Monday Mar 09, 2020 at 19:49:48_

----

Hello. I'm unable to reproduce any crash regarding this particular issue on master as of 03/09/2020. Feel free to reopen an issue if you come across something new regarding this. Thank you.

[Edit]

Tankfest on the Discord came across this issue. Seems like the crash happens only when you have a food status effect on. Won't happen without it (I tried with multiple regular buffs only). My fault.


----
<a href="https://github.com/ibm2431"><img src="https://avatars3.githubusercontent.com/u/13112942?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [ibm2431](https://github.com/ibm2431)**
_Monday Apr 13, 2020 at 22:51:10_

----

Addressed by #492 . The status container still needs work, and checks for cancel-able buffs need to happen (in general, not just for buff theft), but Tap moves are currently the only abilities that caused crashing in this manner (that I'm aware of, at least).
