**Labels:**

bug



<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="96" height="96" hspace="10"></img></a> **Issue by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:59:32_
_Originally opened as: project-topaz/topaz - Issue 263_

----

<a href="https://github.com/przemoc1"><img src="https://avatars3.githubusercontent.com/u/12733817?v=4"  width="96" height="96" hspace="10"></img></a> **Issue by [przemoc1](https://github.com/przemoc1)**
_Tuesday Feb 19, 2019 at 12:19 GMT_
_Originally opened as DarkstarProject/darkstar - Issue 5756_

----

<!-- place 'x' mark between square [] brackets to checkmark box -->

**_I have:_**

- [x] searched existing issues (http://github.com/darkstarproject/darkstar - Issue ) to see if the issue I am posting has already been addressed or opened by another contributor
- [x] checked the commit log to see if my issue has been resolved since my server was last updated


<!-- Issues will be closed without being looked into if the following information is missing (unless its not applicable). -->

**_Client Version_** (type `/ver` in game) **:30190202_0** 


**_Source Branch_** (master/stable) **:master** 


<!-- If there is a server you know we can reproduce this on right now, please mention it here. -->
**_Additional Information_** (Steps to reproduce/Expected behavior) **:Trading required items to ??? at the place brings no effect (??? is not accepting traded items).** 





----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:59:33_

----

<a href="https://github.com/ibm2431"><img src="https://avatars3.githubusercontent.com/u/13112942?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [ibm2431](https://github.com/ibm2431)**
_Tuesday Feb 19, 2019 at 12:53 GMT_

----

[Jailer of Justice spawning seems to be commented out](github/DarkstarProject/darkstar/blob/master/scripts/zones/AlTaieu/npcs/qm2.lua). Its [mob file looks mostly empty](github/DarkstarProject/darkstar/blob/master/scripts/zones/AlTaieu/mobs/Jailer_of_Justice.lua); I'd wager it is not fully implemented yet.



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:59:34_

----

<a href="https://github.com/TeoTwawki"><img src="https://avatars0.githubusercontent.com/u/6871475?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [TeoTwawki](https://github.com/TeoTwawki)**
_Tuesday Feb 19, 2019 at 14:48 GMT_

----

its default disabled for loot pinata reasons. so are several other NM in SEA



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:59:35_

----

<a href="https://github.com/KnowOne134"><img src="https://avatars3.githubusercontent.com/u/35616771?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [KnowOne134](https://github.com/KnowOne134)**
_Monday Jul 08, 2019 at 20:02 GMT_

----

Can close as the mob is just not coded to standards



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:59:36_

----

<a href="https://github.com/TeoTwawki"><img src="https://avatars0.githubusercontent.com/u/6871475?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [TeoTwawki](https://github.com/TeoTwawki)**
_Monday Jul 08, 2019 at 20:03 GMT_

----

I left it open so it doewsn't get re-reported



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:59:38_

----

<a href="https://github.com/KnowOne134"><img src="https://avatars3.githubusercontent.com/u/35616771?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [KnowOne134](https://github.com/KnowOne134)**
_Monday Jul 08, 2019 at 20:06 GMT_

----

Fair enough. I have it updated on my server. Maybe I'll just pr it and we can close. Unless you want to do them all 1st



----
<a href="https://github.com/topaz-bot"><img src="https://avatars3.githubusercontent.com/u/59651103?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [topaz-bot](https://github.com/topaz-bot)**
_Wednesday Jan 08, 2020 at 14:59:39_

----

<a href="https://github.com/TeoTwawki"><img src="https://avatars0.githubusercontent.com/u/6871475?v=4"  width="48" height="48" hspace="10"></img></a> **Comment by [TeoTwawki](https://github.com/TeoTwawki)**
_Monday Jul 08, 2019 at 20:09 GMT_

----

Bring justice down upon him, let no loot pinata escape.

PR for great justice, launch every zig.



----
<a href="https://github.com/jarmengaud"><img src="https://avatars3.githubusercontent.com/u/52013132?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [jarmengaud](https://github.com/jarmengaud)**
_Sunday Oct 04, 2020 at 18:40:40_

----

Someone knows if @KnowOne134  has submitted the PR he mentioned, back in 2019...?
I think this is the only missing Jailer to reach Jailer of Love...


----
<a href="https://github.com/TeoTwawki"><img src="https://avatars0.githubusercontent.com/u/6871475?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [TeoTwawki](https://github.com/TeoTwawki)**
_Monday Oct 05, 2020 at 16:27:37_

----

It appears the jailer spawning his pets and the pets using mijin is coded. I dunno what else was needed


----
<a href="https://github.com/KnowOne134"><img src="https://avatars3.githubusercontent.com/u/35616771?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [KnowOne134](https://github.com/KnowOne134)**
_Monday Oct 05, 2020 at 16:30:44_

----

My old lua. Its out dated now though for a newer version

-- Add the below to the bottom of mob_spell_lists.sql, make sure to update 316 to be 1 higher than the spell list above it, increase by 1 for each element.
-- Making it too high errors out, I tried that. Maybe you can raise the cap somewhere.
--
-- -- Jailer of Love
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 316, 147, 1, 255); -- Fire IV
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 316, 176, 1, 255); -- Firaga III
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 317, 162, 1, 255); -- Stone IV
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 317, 191, 1, 255); -- Stonega III
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 318, 172, 1, 255); -- Water IV
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 318, 201, 1, 255); -- Waterga III
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 319, 157, 1, 255); -- Aero IV
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 319, 186, 1, 255); -- Aeroga III
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 320, 152, 1, 255); -- Blizzard IV
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 320, 181, 1, 255); -- Blizzaga III
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 321, 167, 1, 255); -- Thunder IV
-- INSERT INTO `mob_spell_lists` VALUES ('Jailer_of_Love', 321, 196, 1, 255); -- Thundaga III
--
-- Update mob_pools.sql to the below. Note the 316, change that to whatever you changed it to above for the Fire Element.
--
-- INSERT INTO `mob_pools` VALUES (2134,'Jailer_of_Love','Jailer_of_Love',271,0x00007C0400000000000000000000000000000000,4,4,7,220,125,0,1,1,0,2,0,0,0,0,1,0,316,1,0,271);
--
-- Update mob_spawn_points.sql to make the mobname (2nd variable) start with JoL_ (example: JoL_Qn_xzomit) for the following range of IDs: 16912858 -> 16912875
--
-- Update JoL_Qn_hpemde.lua and JoL_Qn_xzomit.lua to replace the existing onMobDeath function with the following:
--
-- function onMobDeath(mob, player, isKiller)
--      local JoL = GetMobByID(16912848);
--      JoL:setLocalVar("JoL_Qn_hpemde_Killed", JoL:getLocalVar("JoL_Qn_hpemde_Killed") + 1);
--  end;
--
-- function onMobDeath(mob, player, isKiller)
--      local JoL = GetMobByID(16912848);
--      JoL:setLocalVar("JoL_Qn_xzomit_Killed", JoL:getLocalVar("JoL_Qn_xzomit_Killed") + 1);
--  end;
-----------------------------------
local ID = require("scripts/zones/AlTaieu/IDs")
require("scripts/globals/status")
require("scripts/globals/magic")
-----------------------------------

local JoL = 16912848;
local phaseTime = 150;
local phase2Time = math.random(120,180);
local initialRegen = 750;
local finalRegen = 100;
local spellListIndex = 315;

local xzomit = {};
xzomit[0] = {16912858, 16912859, 16912860};
xzomit[1] = {16912861, 16912862, 16912863}; 
xzomit[2] = {16912864, 16912865, 16912866};

local hpemde = {};
hpemde[0] = {16912867, 16912868, 16912869};
hpemde[1] = {16912870, 16912871, 16912872};
hpemde[2] = {16912873, 16912874, 16912875};

local phuabo = {};
phuabo[0] = {16912849, 16912850, 16912851};
phuabo[1] = {16912852, 16912853, 16912854};
phuabo[2] = {16912855, 16912856, 16912857};


function onMobInitialize(mob)
end;

function onMobSpawn(mob)

    mob:setLocalVar("despawnTime", os.time(t) + 7200);
    mob:hideName(false);
    mob:untargetable(false);
    mob:setMobMod(dsp.mobMod.HP_STANDBACK,-1); -- This fixes the issue with its casting, stole it from Eald'narche's script, did a 2min test, it worked. - Loco
    mob:AnimationSub(6);
    mob:addMod(dsp.mod.UDMGMAGIC, -64);
    mob:addMod(dsp.mod.REGEN, initialRegen);
	mob:addMod(dsp.mod.SILENCERES, 70);
	mob:addMod(dsp.mod.BINDRES, 200);
	mob:addMod(dsp.mod.SLEEPRES, 200);
    mob:addMod(dsp.mod.GRAVITYRES, 200);
end;

function onMobEngaged(mob, killer)
    
    mob:hideName(false);
    mob:untargetable(false);
    mob:AnimationSub(6);
    mob:setLocalVar("changeTime", 0);
    mob:setLocalVar("phase", 0);
    mob:setLocalVar("resistantElem", 0); 
    mob:setLocalVar("JoL_Qn_xzomit_Killed", 0);
    mob:setLocalVar("JoL_Qn_hpemde_Killed", 0);
    mob:setLocalVar("elementTime", 0);
end;

function onMobFight(mob, target)
    -- Only 9 Qn'xzomit and 9 Qn'hpemde can be summoned. Ru'phuabo (Sharks) are unlimited.
    -- After 9 Qn'xzomit and 9 Qn'hpemde have been summoned, reduce Regen to finalRegen.
    -- 
    -- We keep track of them by the pets updating a local var in their onMobDeath
	
	-- mob:addMP(mob:getMaxMP()); -- Temp fix for MP issue

    local changeTime = mob:getLocalVar("changeTime");
    if mob:getBattleTime() > changeTime then -- Change places! er... phases
        
        local phase = mob:getLocalVar("phase");
        local phaseMod = phase % 3;
        local phaseDiv = math.floor(phase / 3);
        local pet = nil;
--        printf("Phase: %s Regen %s", phase, mob:getMod(dsp.mod.REGEN))
--        printf("Xzomuts: %s Hpedes: %s", mob:getLocalVar("JoL_Qn_xzomit_Killed"), mob:getLocalVar("JoL_Qn_hpemde_Killed"))
        for i = 1, 3 do
            if phase < 9 then
                if      (phaseMod == 0) then SpawnMob(xzomit[phaseDiv][i]):updateEnmity(target);
                elseif  (phaseMod == 1) then SpawnMob(hpemde[phaseDiv][i]):updateEnmity(target);
                elseif  (phaseMod == 2) then SpawnMob(phuabo[phaseDiv][i]):updateEnmity(target);
                end;
            else
                SpawnMob(phuabo[phaseMod][i]):updateEnmity(target);
            end;
        end;
        
        if phase > 8 and mob:getLocalVar("JoL_Qn_xzomit_Killed") == 9 and mob:getLocalVar("JoL_Qn_hpemde_Killed") == 9 then
            mob:setMod(dsp.mod.REGEN, finalRegen);
        end;
        
        mob:setLocalVar("changeTime", changeTime + phaseTime);
        mob:setLocalVar("phase", phase + 1);
        handleResistantElement(mob);
    end;
     
    if os.time(t) > mob:getLocalVar("despawnTime") then
        DespawnMob(JoL);
        for i = 0, 2 do
            for j = 1, 3 do
                DespawnMob(xzomit[i][j]);
                DespawnMob(hpemde[i][j]);
                DespawnMob(phuabo[i][j]);
            end;
        end;
    end;
	
end;

function handleResistantElement(mob)
    local spellListIndex = 315
    local elementTime = mob:getLocalVar("elementTime");
        local mods = {dsp.mod.FIRE_ABSORB, dsp.mod.EARTH_ABSORB, dsp.mod.WATER_ABSORB, dsp.mod.WIND_ABSORB, dsp.mod.ICE_ABSORB, dsp.mod.LTNG_ABSORB};
        local currElem = mob:getLocalVar("resistantElem");
        local newElem = math.random(1, 6);
        mob:delMod(mods[currElem], 100)
        mob:addMod(mods[newElem], 100);
        mob:setSpellList(spellListIndex + newElem);
        mob:setLocalVar("resistantElem", newElem);
	    mob:addMP(mob:getMaxMP());
	    mob:setLocalVar("elementTime", elementTime + phase2Time);
end;

function onMobDeath(mob, player, killer)

    player:addCurrency("cruor", math.random(500,700));
    for i = 0, 2 do
        for j = 1, 3 do
            DespawnMob(xzomit[i][j]);
            DespawnMob(hpemde[i][j]);
            DespawnMob(phuabo[i][j]);
        end
    end
end


function onMobDespawn(mob)
--    if math.random(100) <= 25 then -- 25% chance to spawn Absolute Virtue
        SpawnMob(ID.mob.ABSOLUTE_VIRTUE)
--    end
end


----
<a href="https://github.com/jarmengaud"><img src="https://avatars3.githubusercontent.com/u/52013132?v=4" width="48" height="48" hspace="10"></img></a> **Comment by [jarmengaud](https://github.com/jarmengaud)**
_Saturday Oct 10, 2020 at 12:49:07_

----

Thanks a lot! Will certainly help if we try to do this.
