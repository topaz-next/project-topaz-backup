@@ -10,37 +10,83 @@ require("scripts/globals/status")
 -----------------------------------
 
 function onTrade(player, npc, trade)
+    local signed = trade:getItem():getSignature() == player:getName() and 1 or 0
     local newRank = tradeTestItem(player, npc, trade, tpz.skill.SMITHING)
 
-    if (newRank ~= 0) then
+    if
+        newRank > 9 and
+        player:getCharVar("SmithingExpertQuest") == 1 and
+        player:hasKeyItem(tpz.keyItem.WAY_OF_THE_BLACKSMITH)
+    then
+        if signed ~=0 then
+            player:setSkillRank(tpz.skill.SMITHING, newRank)
+            player:startEvent(627, 0, 0, 0, 0, newRank, 1)
+            player:setCharVar("SmithingExpertQuest",2)
+            player:setCharVar("SmithingTraded",1)
+        else
+            player:startEvent(627, 0, 0, 0, 0, newRank, 0)
+        end
+    elseif newRank ~= 0 and newRank <=9 then
         player:setSkillRank(tpz.skill.SMITHING, newRank)
         player:startEvent(627, 0, 0, 0, 0, newRank)
+        player:setCharVar("SmithingTraded",1)
     end
 end
 
 function onTrigger(player, npc)
-    local getNewRank = 0
     local craftSkill = player:getSkillLevel(tpz.skill.SMITHING)
     local testItem = getTestItem(player, npc, tpz.skill.SMITHING)
     local guildMember = isGuildMember(player, 8)
+    local rankCap = getCraftSkillCap(player, tpz.skill.SMITHING)
+    local expertQuestStatus = 0
+    local Rank = player:getSkillRank(tpz.skill.SMITHING)
+    local realSkill = (craftSkill - Rank) / 32
     if (guildMember == 1) then guildMember = 150995375; end
-    if (canGetNewRank(player, craftSkill, tpz.skill.SMITHING) == 1) then getNewRank = 100; end
 
-    player:startEvent(626, testItem, getNewRank, 30, guildMember, 44, 0, 0, 0)
+    if player:getCharVar("SmithingExpertQuest") == 1 then
+        if player:hasKeyItem(tpz.keyItem.WAY_OF_THE_BLACKSMITH) then
+            expertQuestStatus = 550
+        else
+            expertQuestStatus = 600
+        end
+    end
+
+    if expertQuestStatus == 550 then
+        --[[  Feeding the proper parameter currently hangs the client in cutscene. This may
+              possibly be due to an unimplemented packet or function (display recipe?) Work
+              around to present dialog to player to let them know the trade is ready to be
+              received by triggering with lower rank up parameters.  ]]--
+        player:showText(npc, 7138)
+        player:showText(npc, 7140)
+        player:startEvent(626, testItem, realSkill, 44, guildMember, 0, 0, 0, 0)
+    else
+        player:startEvent(626, testItem, realSkill, rankCap, guildMember, expertQuestStatus, 0, 0, 0)
+    end
 end
 
 -- 626  627  16  0  73  74
 function onEventUpdate(player, csid, option)
 end
 
 function onEventFinish(player, csid, option)
-    if (csid == 626 and option == 1) then
+    local guildMember = isGuildMember(player, 8)
+
+    if (csid == 626 and option == 2) then
+        if guildMember == 1 then
+            player:setCharVar("SmithingExpertQuest",1)
+        end
+    elseif (csid == 626 and option == 1) then
         if (player:getFreeSlotsCount() == 0) then
             player:messageSpecial(ID.text.ITEM_CANNOT_BE_OBTAINED, 4096)
         else
             player:addItem(4096)
             player:messageSpecial(ID.text.ITEM_OBTAINED, 4096) -- Fire Crystal
             signupGuild(player, guild.smithing)
         end
+    else
+        if player:getCharVar("SmithingTraded") == 1 then
+            player:tradeComplete()
+            player:setCharVar("SmithingTraded",0)
+        end
     end
 end